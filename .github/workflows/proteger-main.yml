name: 'ğŸ”’ Proteger branch main'

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# ObservaÃ§Ã£o importante:
# - Normalmente o GITHUB_TOKEN nÃ£o tem permissÃ£o para alterar Branch Protection.
# - Crie um PAT (fine-grained ou classic) com permissÃ£o de administraÃ§Ã£o do repositÃ³rio
#   e salve como secret BRANCH_PROTECTION_TOKEN.
permissions:
  contents: read

jobs:
  proteger-main:
    name: 'ğŸ›¡ï¸ Aplicar Branch Protection (main)'
    runs-on: ubuntu-latest
    env:
      BRANCH_PROTECTION_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
    steps:
      - name: 'ğŸ” Validar token de proteÃ§Ã£o'
        if: env.BRANCH_PROTECTION_TOKEN == ''
        run: |
          echo "Secret BRANCH_PROTECTION_TOKEN nÃ£o configurada."
          echo "Crie um token com permissÃ£o de administraÃ§Ã£o do repositÃ³rio e adicione em Settings > Secrets and variables > Actions."
          exit 1

      - name: 'ğŸ”§ Aplicar proteÃ§Ã£o via GitHub API'
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.BRANCH_PROTECTION_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';

            // Alinhar com os nomes reais dos checks do workflow ".github/workflows/ci.yml".
            // Em GitHub Actions, o contexto costuma ser: "<nome do workflow> / <nome do job>".
            const requiredContexts = [
              'ğŸ”„ CI - IntegraÃ§Ã£o ContÃ­nua / ğŸ” Qualidade do CÃ³digo',
              'ğŸ”„ CI - IntegraÃ§Ã£o ContÃ­nua / ğŸ“œ Auditoria de LicenÃ§as',
              'ğŸ”„ CI - IntegraÃ§Ã£o ContÃ­nua / ğŸ—ï¸ Build do Projeto',
            ];

            // Falha rÃ¡pido se a branch nÃ£o existir.
            await github.request('GET /repos/{owner}/{repo}/branches/{branch}', {
              owner,
              repo,
              branch,
            });

            await github.request('PUT /repos/{owner}/{repo}/branches/{branch}/protection', {
              owner,
              repo,
              branch,

              required_status_checks: {
                strict: true,
                contexts: requiredContexts,
              },

              enforce_admins: true,

              required_pull_request_reviews: {
                dismiss_stale_reviews: true,
                require_code_owner_reviews: false,
                required_approving_review_count: 1,
              },

              restrictions: null,
              allow_force_pushes: false,
              allow_deletions: false,
              required_conversation_resolution: true,
            });

            core.summary
              .addHeading('ğŸ”’ ProteÃ§Ã£o aplicada')
              .addList([
                `Repo: ${owner}/${repo}`,
                `Branch: ${branch}`,
                `Checks obrigatÃ³rios: ${requiredContexts.join(' | ')}`,
                'PR review: 1 aprovaÃ§Ã£o (stale reviews dispensadas)',
                'Force push: bloqueado',
                'DeleÃ§Ã£o da branch: bloqueada',
                'ResoluÃ§Ã£o de conversas: obrigatÃ³ria',
              ])
              .write();
