#
# CI - IntegraÃ§Ã£o ContÃ­nua
#
# Workflow principal que executa todas as verificaÃ§Ãµes de qualidade do cÃ³digo
# Executa em: push e pull requests para main e develop
#

name: ðŸ”„ CI - IntegraÃ§Ã£o ContÃ­nua

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'

jobs:
  #
  # JOB 1: VerificaÃ§Ã£o de Qualidade do CÃ³digo
  #
  qualidade-codigo:
    name: ðŸ” Qualidade do CÃ³digo
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Baixar cÃ³digo fonte
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ” Verificar ESLint (JavaScript/TypeScript)
        run: npm run lint

      - name: ðŸŽ¨ Verificar Stylelint (CSS)
        run: npm run lint:css

      - name: ðŸ“ Verificar FormataÃ§Ã£o (Prettier)
        run: npm run format:check

      - name: ðŸ”· Verificar Tipos (TypeScript)
        run: npm run type-check

      - name: ðŸ–¼ï¸ Verificar OtimizaÃ§Ã£o SVG
        run: npm run lint:svg
        continue-on-error: true

      - name: ðŸ“„ Verificar YAML
        run: npm run lint:yaml
        continue-on-error: true

      - name: ðŸ§ª Verificar Workflows (Actionlint)
        run: npm run lint:actions
        continue-on-error: true

      - name: ðŸ“Š Resumo da Qualidade
        if: always()
        run: |
          echo "## ðŸ” RelatÃ³rio de Qualidade do CÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### VerificaÃ§Ãµes Executadas:" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaÃ§Ã£o | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | âœ… Aprovado |" >> $GITHUB_STEP_SUMMARY
          echo "| Stylelint | âœ… Aprovado |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | âœ… Aprovado |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | âœ… Aprovado |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Œ **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  #
  # JOB 2: Auditoria de LicenÃ§as
  #
  auditoria-licencas:
    name: ðŸ“œ Auditoria de LicenÃ§as
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Baixar cÃ³digo fonte
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ” Gerar relatÃ³rio de licenÃ§as (JSON)
        run: npm run license:audit

      - name: ðŸ“‹ Gerar resumo de licenÃ§as (Texto)
        run: npm run license:report

      - name: ðŸ“¤ Salvar relatÃ³rios de licenÃ§as
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-licencas
          path: |
            licenses-audit.json
            LICENSES_SUMMARY.txt
          retention-days: 30

      - name: ðŸ“Š Resumo das LicenÃ§as
        run: |
          echo "## ðŸ“œ RelatÃ³rio de LicenÃ§as" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Auditoria de licenÃ§as concluÃ­da com sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **DependÃªncias analisadas:**" >> $GITHUB_STEP_SUMMARY
          echo "- ProduÃ§Ã£o: \`$(jq '.dependencies | length' package.json)\` pacotes" >> $GITHUB_STEP_SUMMARY
          echo "- Desenvolvimento: \`$(jq '.devDependencies | length' package.json)\` pacotes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ RelatÃ³rios disponÃ­veis nos artefatos do workflow." >> $GITHUB_STEP_SUMMARY

  #
  # JOB 3: Auditoria de SeguranÃ§a
  #
  auditoria-seguranca:
    name: ðŸ” Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Baixar cÃ³digo fonte
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ” Executar npm audit
        id: audit
        run: |
          echo "## ðŸ” RelatÃ³rio de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Executar audit e capturar resultado
          if npm audit --audit-level=high 2>&1; then
            echo "âœ… **Nenhuma vulnerabilidade crÃ­tica encontrada!**" >> $GITHUB_STEP_SUMMARY
            echo "audit_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ **Vulnerabilidades encontradas**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Execute \`npm audit\` localmente para mais detalhes." >> $GITHUB_STEP_SUMMARY
            echo "audit_status=warning" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ðŸ“Š Detalhes da Auditoria
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Resumo:" >> $GITHUB_STEP_SUMMARY
          npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities | "- CrÃ­ticas: \(.critical)\n- Altas: \(.high)\n- Moderadas: \(.moderate)\n- Baixas: \(.low)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- Detalhes nÃ£o disponÃ­veis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Dica:** Vulnerabilidades de baixa severidade em dependÃªncias de desenvolvimento sÃ£o geralmente aceitÃ¡veis." >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  #
  # JOB 4: Build do Projeto
  #
  build:
    name: ðŸ—ï¸ Build do Projeto
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [qualidade-codigo, auditoria-licencas]

    steps:
      - name: ðŸ“¥ Baixar cÃ³digo fonte
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ“¦ Cache do Next.js
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: ðŸ”¨ Compilar projeto
        run: npm run build
        env:
          NODE_ENV: production

      - name: ðŸ“Š Resumo do Build
        run: |
          echo "## ðŸ—ï¸ Build ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ InformaÃ§Ãµes do Build:" >> $GITHUB_STEP_SUMMARY
          echo "| InformaÃ§Ã£o | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Autor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Data | $(date -u '+%d/%m/%Y %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š EstatÃ­sticas do Projeto:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ Arquivos TypeScript: \`$(find . -name '*.ts' -o -name '*.tsx' | grep -v node_modules | grep -v .next | wc -l)\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Arquivos CSS: \`$(find . -name '*.css' | grep -v node_modules | wc -l)\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¼ï¸ Arquivos SVG: \`$(find . -name '*.svg' | grep -v node_modules | wc -l)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Pronto para deploy!**" >> $GITHUB_STEP_SUMMARY

  #
  # JOB 5: NotificaÃ§Ã£o de Resultado Final
  #
  notificacao:
    name: ðŸ“¢ Resultado Final
    runs-on: ubuntu-latest
    needs: [qualidade-codigo, auditoria-licencas, auditoria-seguranca, build]
    if: always()

    steps:
      - name: ðŸ“Š Gerar RelatÃ³rio Final
        run: |
          echo "## ðŸŽ¯ Resultado da IntegraÃ§Ã£o ContÃ­nua" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status dos Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Qualidade do CÃ³digo | ${{ needs.qualidade-codigo.result == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“œ Auditoria de LicenÃ§as | ${{ needs.auditoria-licencas.result == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Auditoria de SeguranÃ§a | ${{ needs.auditoria-seguranca.result == 'success' && 'âœ… Aprovado' || 'âš ï¸ AtenÃ§Ã£o' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Aprovado' || 'âŒ Falhou' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "### ðŸŽ‰ Todas as verificaÃ§Ãµes passaram!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "O cÃ³digo estÃ¡ pronto para ser mesclado ou implantado." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Algumas verificaÃ§Ãµes falharam" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Por favor, revise os logs acima para mais detalhes." >> $GITHUB_STEP_SUMMARY
          fi
