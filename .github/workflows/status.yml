# =============================================================================
# Status Check - RelatÃ³rio de SaÃºde do Projeto
# =============================================================================
# Gera um relatÃ³rio completo do status do projeto
# Executa em: push e pull requests para main, develop e developer
# =============================================================================

name: ðŸ“Š Status do Projeto

on:
  push:
    branches: [main, develop, developer]
  pull_request:
    branches: [main, develop, developer]

env:
  NODE_VERSION: '24'

jobs:
  # ===========================================================================
  # JOB: RelatÃ³rio de Status
  # ===========================================================================
  relatorio-status:
    name: ðŸ“‹ Gerar RelatÃ³rio de Status
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always()

    steps:
      - name: ðŸ“¥ Baixar cÃ³digo fonte
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: ðŸ” VerificaÃ§Ã£o RÃ¡pida de SaÃºde
        id: health
        run: |
          echo "## ðŸ¥ VerificaÃ§Ã£o de SaÃºde do Projeto" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” VerificaÃ§Ãµes AutomÃ¡ticas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaÃ§Ã£o | Status | DescriÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY

          # ESLint
          if npm run lint > /dev/null 2>&1; then
            echo "| ðŸ” ESLint | âœ… Aprovado | CÃ³digo JavaScript/TypeScript vÃ¡lido |" >> $GITHUB_STEP_SUMMARY
            echo "eslint=success" >> $GITHUB_OUTPUT
          else
            echo "| ðŸ” ESLint | âŒ Falhou | Problemas encontrados no cÃ³digo |" >> $GITHUB_STEP_SUMMARY
            echo "eslint=failed" >> $GITHUB_OUTPUT
          fi

          # TypeScript
          if npm run type-check > /dev/null 2>&1; then
            echo "| ðŸ”· TypeScript | âœ… Aprovado | Nenhum erro de tipo |" >> $GITHUB_STEP_SUMMARY
            echo "typescript=success" >> $GITHUB_OUTPUT
          else
            echo "| ðŸ”· TypeScript | âŒ Falhou | Erros de tipo encontrados |" >> $GITHUB_STEP_SUMMARY
            echo "typescript=failed" >> $GITHUB_OUTPUT
          fi

          # Stylelint
          if npm run lint:css > /dev/null 2>&1; then
            echo "| ðŸŽ¨ Stylelint | âœ… Aprovado | Estilos CSS vÃ¡lidos |" >> $GITHUB_STEP_SUMMARY
            echo "stylelint=success" >> $GITHUB_OUTPUT
          else
            echo "| ðŸŽ¨ Stylelint | âŒ Falhou | Problemas nos estilos CSS |" >> $GITHUB_STEP_SUMMARY
            echo "stylelint=failed" >> $GITHUB_OUTPUT
          fi

          # Prettier
          if npm run format:check > /dev/null 2>&1; then
            echo "| ðŸ“ Prettier | âœ… Aprovado | CÃ³digo bem formatado |" >> $GITHUB_STEP_SUMMARY
            echo "prettier=success" >> $GITHUB_OUTPUT
          else
            echo "| ðŸ“ Prettier | âš ï¸ AtenÃ§Ã£o | FormataÃ§Ã£o inconsistente |" >> $GITHUB_STEP_SUMMARY
            echo "prettier=warning" >> $GITHUB_OUTPUT
          fi

          # Build
          if npm run build > /dev/null 2>&1; then
            echo "| ðŸ—ï¸ Build | âœ… Aprovado | CompilaÃ§Ã£o bem-sucedida |" >> $GITHUB_STEP_SUMMARY
            echo "build=success" >> $GITHUB_OUTPUT
          else
            echo "| ðŸ—ï¸ Build | âŒ Falhou | Erro na compilaÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
            echo "build=failed" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: ðŸ“Š EstatÃ­sticas do Projeto
        run: |
          echo "### ðŸ“Š EstatÃ­sticas do Projeto:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“ Contagem de Arquivos:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“„ TypeScript (.ts/.tsx) | \`$(find . -name '*.ts' -o -name '*.tsx' | grep -v node_modules | grep -v .next | wc -l)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ CSS | \`$(find . -name '*.css' | grep -v node_modules | wc -l)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ MDX/Markdown | \`$(find . -name '*.mdx' -o -name '*.md' | grep -v node_modules | wc -l)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¼ï¸ SVG | \`$(find . -name '*.svg' | grep -v node_modules | wc -l)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ JSON | \`$(find . -name '*.json' | grep -v node_modules | grep -v .next | wc -l)\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ DependÃªncias:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tipo | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ ProduÃ§Ã£o | \`$(jq '.dependencies | length' package.json)\` pacotes |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› ï¸ Desenvolvimento | \`$(jq '.devDependencies | length' package.json)\` pacotes |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: ðŸ” VerificaÃ§Ã£o de SeguranÃ§a
        run: |
          echo "### ðŸ” Auditoria de SeguranÃ§a:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Capturar resultado do audit
          AUDIT_OUTPUT=$(npm audit --json 2>/dev/null || echo '{}')

          CRITICAL=$(echo $AUDIT_OUTPUT | jq -r '.metadata.vulnerabilities.critical // 0')
          HIGH=$(echo $AUDIT_OUTPUT | jq -r '.metadata.vulnerabilities.high // 0')
          MODERATE=$(echo $AUDIT_OUTPUT | jq -r '.metadata.vulnerabilities.moderate // 0')
          LOW=$(echo $AUDIT_OUTPUT | jq -r '.metadata.vulnerabilities.low // 0')

          echo "| Severidade | Quantidade |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ CrÃ­ticas | \`$CRITICAL\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  Altas | \`$HIGH\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderadas | \`$MODERATE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Baixas | \`$LOW\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -eq 0 ] && [ "$HIGH" -eq 0 ]; then
            echo "âœ… **Nenhuma vulnerabilidade crÃ­tica ou alta encontrada!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **AtenÃ§Ã£o:** Existem vulnerabilidades que precisam de atenÃ§Ã£o." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Execute \`npm audit\` localmente para mais detalhes." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: ðŸ“‹ InformaÃ§Ãµes do Ambiente
        run: |
          echo "### ðŸ–¥ï¸ InformaÃ§Ãµes do Ambiente:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Disparado por | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Evento | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Data | $(date -u '+%d/%m/%Y %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Node.js | \`$(node --version)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ npm | \`$(npm --version)\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Status Final
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Resumo Final" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verificar resultados
          ESLINT="${{ steps.health.outputs.eslint }}"
          TYPESCRIPT="${{ steps.health.outputs.typescript }}"
          BUILD="${{ steps.health.outputs.build }}"

          if [ "$ESLINT" == "success" ] && [ "$TYPESCRIPT" == "success" ] && [ "$BUILD" == "success" ]; then
            echo "### âœ… Projeto SaudÃ¡vel!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Todas as verificaÃ§Ãµes principais passaram. O projeto estÃ¡ pronto para deploy!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ AtenÃ§Ã£o NecessÃ¡ria" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Algumas verificaÃ§Ãµes falharam. Por favor, revise os detalhes acima." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Dica:** Para corrigir problemas automaticamente, execute:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm run fix:all" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
