# Plano de Melhorias - Or√°culo v0.3.0

> Proveni√™ncia e Autoria: Este documento integra o projeto Or√°culo (licen√ßa MIT).
> Nada aqui implica cess√£o de direitos morais/autorais.
> Conte√∫dos de terceiros n√£o licenciados de forma compat√≠vel n√£o devem ser inclu√≠dos.
> Refer√™ncias a materiais externos devem ser linkadas e reescritas com palavras pr√≥prias.

**Data Inicial:** 01/12/2025
**√öltima Atualiza√ß√£o:** 29/12/2025
**Fonte:** Feedback detalhado do projeto Barqueiro (Discord Bot)
**Status:** üîÑ Em Progresso

---

## üìã Resumo Executivo

Com base no feedback extensivo recebido do uso real do Or√°culo no projeto Barqueiro, identificamos melhorias cr√≠ticas para reduzir falsos positivos, melhorar a experi√™ncia do usu√°rio e adicionar configurabilidade ao sistema.

**Progresso Atual:**

- ‚úÖ **6 de 10** itens de alta prioridade implementados
- ‚úÖ Sistema de supress√£o inline funcionando
- ‚úÖ Modo JSON corrigido
- ‚úÖ Logs verbosos reduzidos

**Impacto esperado:**

- ‚úÖ Redu√ß√£o de 70-80% nos falsos positivos
- ‚úÖ Maior ado√ß√£o em projetos com frameworks espec√≠ficos (Discord.js, Express, etc)
- ‚úÖ Melhor integra√ß√£o em CI/CD pipelines
- ‚úÖ UX mais profissional e configur√°vel

---

## üéØ Prioridades de Implementa√ß√£o

### üî¥ **Alta Prioridade** (Vers√£o 0.3.0)

#### 1. **Corrigir sistema de supress√£o inline** ‚ö†Ô∏è

**Status:** ‚úÖ Implementado (com testes)
**Arquivo:** `src/shared/helpers/suppressao.ts`
**Status atual:** `@oraculo-disable-next-line` funciona via integra√ß√£o central (`src/shared/helpers/analista-wrapper.ts`) e √© coberto por testes (`tests/shared/suppressao.test.ts`, `tests/analistas/suppressao-e2e.test.ts`).

**Diagn√≥stico:**

- Sistema de supress√£o existe e parece correto
- Poss√≠vel problema na integra√ß√£o com analistas
- Necess√°rio verificar se `filtrarOcorrenciasSuprimidas()` est√° sendo chamado

**Implementa√ß√£o:**

```typescript
// Garantir que TODOS os analistas chamem:
import { filtrarOcorrenciasSuprimidas } from '@/shared/helpers/suppressao';

// Antes de retornar resultados:
const resultadosFiltrados = filtrarOcorrenciasSuprimidas(
  problemas,
  'hardcoded-secrets', // nome da regra
  codigoFonte
);
```

**Testes:**

```typescript
// tests/shared/suppressao.test.ts
describe('@oraculo-disable-next-line', () => {
  it('deve suprimir hardcoded-secrets na linha seguinte', () => {
    const codigo = `
      // @oraculo-disable-next-line hardcoded-secrets
      const key = "squad_role_admin";
    `;
    // Assert: n√£o deve reportar problemas
  });
});
```

**Arquivos afetados:**

- `src/shared/helpers/suppressao.ts` (verifica√ß√£o)
- `src/analistas/detectores/detector-seguranca.ts` (integra√ß√£o)
- `src/analistas/detectores/*.ts` (todos analistas)
- `tests/shared/suppressao.test.ts` (novos testes)

---

#### 2. **Implementar configura√ß√£o estendida (.oraculorc.json)**

**Arquivo:** `oraculo.config.json` (estender schema existente)

**Nova estrutura:**

```json
{
  // ... configura√ß√µes existentes ...

  "ignorePatterns": {
    "hardcoded-secrets": {
      "patterns": ["_role_", "_config_", "_key_"],
      "inTemplates": true
    },
    "magic-constants": {
      "values": [25, 90, 100, 300000],
      "contexts": ["slice", "limit", "take"]
    },
    "unhandled-async": {
      "eventHandlers": true,
      "frameworks": ["discord.js", "express"]
    }
  },

  "severity": {
    "overrides": {
      "unhandled-async-in-event-handlers": "info",
      "magic-constants-in-api-limits": "warning"
    }
  },

  "conventions": {
    "testFramework": "vitest",
    "testLocation": "separate",
    "respectFrameworkPatterns": true
  },

  "frameworks": {
    "autoDetect": true,
    "known": ["discord.js", "express", "fastify", "next.js"]
  }
}
```

**Implementa√ß√£o:**

1. Criar `src/tipos/config-schema.ts` com types completos
2. Adicionar valida√ß√£o de schema com Zod ou similar
3. Migrar `oraculo.config.json` existente para novo formato (backward compatible)
4. Documentar todas op√ß√µes em `docs/CONFIGURACAO.md`

**Arquivos afetados:**

- `src/tipos/config-schema.ts` (novo)
- `src/core/config-loader.ts` (atualizar)
- `oraculo.config.json` (migrar)
- `docs/CONFIGURACAO.md` (novo)

---

#### 3. **Reduzir falsos positivos - hardcoded-secrets**

**Arquivo:** `src/analistas/detectores/detector-seguranca.ts:310-325`

**Problemas identificados:**

1. String templates com `${...}` s√£o din√¢micas, n√£o hardcoded
2. Padr√µes como `_role_`, `_config_`, `_key_` s√£o nomenclatura, n√£o segredos

**Solu√ß√£o:**

```typescript
function pareceTokReal(valor: string, contexto: string): boolean {
  // 1. Ignorar se √© template string com interpola√ß√£o
  if (contexto.includes('${') || /\$\{[^}]+\}/.test(contexto)) {
    return false;
  }

  // 2. Carregar whitelist de padr√µes do config
  const whitelist = config.ignorePatterns?.['hardcoded-secrets']?.patterns || [];
  for (const pattern of whitelist) {
    if (valor.includes(pattern)) {
      return false;
    }
  }

  // 3. L√≥gica existente de entropia e Base64
  const temAltaEntropia = entropia > 3.5;
  const pareceBase64 = /^[A-Za-z0-9+/]{20,}={0,2}$/.test(valor);

  return valor.length > 8 && (temAltaEntropia || pareceBase64) && !isPlaceholder;
}
```

**Testes:**

```typescript
it('n√£o deve reportar string templates din√¢micas', () => {
  const codigo = 'const key = `squad_role_${type.toLowerCase()}`;';
  // Assert: sem problemas
});

it('deve respeitar whitelist de padr√µes', () => {
  const codigo = 'const key = "squad_role_admin";';
  const config = { ignorePatterns: { 'hardcoded-secrets': { patterns: ['_role_'] } } };
  // Assert: sem problemas
});
```

---

#### 4. **Reduzir falsos positivos - unhandled-async**

**Arquivo:** `src/analistas/detectores/detector-seguranca.ts:338-360`

**Problema:**
Event handlers (`on`, `once`) s√£o fire-and-forget por design, n√£o precisam de try-catch obrigat√≥rio.

**Solu√ß√£o:**

```typescript
function detectarAsyncSemTryCatch(src: string, problemas: ProblemaSeguranca[]): void {
  const lines = src.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (/\bawait\s+/.test(line) && !line.trim().startsWith('//')) {
      // 1. Detectar contexto de event handler
      const contextLines = lines.slice(Math.max(0, i - 10), i);
      const context = contextLines.join(' ');

      const isEventHandler =
        /\.on\s*\(/.test(context) ||
        /\.once\s*\(/.test(context) ||
        /addEventListener\s*\(/.test(context) ||
        /collector\.on\s*\(/.test(context);

      // 2. Verificar se h√° try-catch
      const hasErrorHandling =
        context.includes('try') || context.includes('catch') || line.includes('.catch');

      if (!hasErrorHandling) {
        problemas.push({
          tipo: isEventHandler ? 'unhandled-async-event' : 'unhandled-async',
          descricao: isEventHandler
            ? 'await em event handler sem tratamento de erro'
            : 'await sem tratamento de erro pode causar crashes',
          severidade: isEventHandler ? 'baixa' : 'media',
          linha: i + 1,
          sugestao: isEventHandler
            ? 'Considere adicionar .catch() ou try-catch se necess√°rio'
            : 'Envolva em try-catch ou use .catch() na Promise'
        });
      }
    }
  }
}
```

**Configura√ß√£o:**

```json
{
  "ignorePatterns": {
    "unhandled-async": {
      "eventHandlers": true // Reduz para 'info' ou ignora completamente
    }
  }
}
```

---

#### 5. **Corrigir modo --json**

**Arquivo:** `src/cli/comandos/diagnosticar.ts` ou similar

**Problema:**
Output mistura logs `INFO` com JSON, quebrando parsers:

```
[12:43:59] INFO    Arquivos analisados: 60/60
{"ocorrencias": [...]}
```

**Solu√ß√£o:**

```typescript
// No in√≠cio do comando diagnosticar
if (opcoes.json) {
  // Desabilitar TODOS os logs visuais
  process.env.ORACULO_SILENT = 'true';

  // Ou usar flag global
  globalThis.ORACULO_JSON_MODE = true;
}

// Em todos os helpers de logging
function log(mensagem: string) {
  if (globalThis.ORACULO_JSON_MODE) {
    return; // N√£o logar nada
  }
  console.log(mensagem);
}

// No final do comando
if (opcoes.json) {
  console.log(JSON.stringify(resultado, null, 2));
} else {
  // Output visual normal
}
```

**Testes:**

```bash
npm run diagnosticar -- --json | jq .
# Deve retornar JSON v√°lido sem erros
```

---

### üü° **M√©dia Prioridade** (Vers√£o 0.3.1)

#### 6. **Implementar whitelist de magic constants**

**Arquivo:** Criar `src/analistas/detectores/magic-constants-whitelist.ts`

**Whitelists conhecidas:**

```typescript
export const KNOWN_API_LIMITS = {
  'discord.js': {
    25: 'SelectMenu max options',
    90: 'SelectMenu label max length',
    100: 'MessageEmbed field value max length',
    1024: 'MessageEmbed field value max length',
    4000: 'MessageEmbed description max length',
    6000: 'Message content max length'
  },
  stripe: {
    100: 'API default page size',
    500: 'Description max length'
  },
  'twitter-api': {
    280: 'Tweet max length',
    100: 'Timeline default count'
  }
};
```

**Integra√ß√£o com detector:**

```typescript
function isMagicConstant(valor: number, contexto: string): boolean {
  // 1. Verificar whitelist do usu√°rio
  const userWhitelist = config.ignorePatterns?.['magic-constants']?.values || [];
  if (userWhitelist.includes(valor)) {
    return false;
  }

  // 2. Auto-detectar framework (via package.json)
  const framework = detectFramework();
  const knownLimits = KNOWN_API_LIMITS[framework] || {};

  if (valor in knownLimits) {
    return false; // √â um limite conhecido da API
  }

  // 3. Verificar contexto (slice, take, limit)
  const allowedContexts = config.ignorePatterns?.['magic-constants']?.contexts || [];
  for (const ctx of allowedContexts) {
    if (contexto.includes(`.${ctx}(`)) {
      return false;
    }
  }

  return true; // √â magic constant de verdade
}
```

---

#### 7. **Melhorar exit codes**

**Arquivo:** `src/cli/index.ts` ou `src/bin/index.ts`

**Implementa√ß√£o:**

```typescript
const EXIT_CODES = {
  SUCCESS: 0, // Tudo OK ou apenas info/warnings
  ERROR: 1, // Erros encontrados
  CRITICAL: 2, // Problemas cr√≠ticos
  INVALID_USAGE: 3 // Erro de CLI (args inv√°lidos)
} as const;

// No final do diagn√≥stico
const temCriticos = ocorrencias.some((o) => o.severidade === 'critica');
const temErros = ocorrencias.some((o) => o.severidade === 'alta');

if (temCriticos) {
  process.exit(EXIT_CODES.CRITICAL);
} else if (temErros) {
  process.exit(EXIT_CODES.ERROR);
} else {
  process.exit(EXIT_CODES.SUCCESS);
}
```

**Documenta√ß√£o:**

```markdown
## Exit Codes

| C√≥digo | Significado       | Quando ocorre                       |
| ------ | ----------------- | ----------------------------------- |
| 0      | Sucesso           | Sem problemas ou apenas avisos/info |
| 1      | Erros encontrados | Problemas de severidade 'alta'      |
| 2      | Cr√≠tico           | Problemas de severidade 'critica'   |
| 3      | Uso inv√°lido      | Argumentos CLI incorretos           |
```

---

#### 8. **Detec√ß√£o de contexto de framework**

**Arquivo:** Criar `src/shared/helpers/framework-detector.ts`

```typescript
export interface FrameworkContext {
  name: string;
  version: string;
  knownPatterns: Record<string, any>;
}

export function detectFramework(projectRoot: string): FrameworkContext | null {
  const packageJson = readPackageJson(projectRoot);

  const dependencies = {
    ...packageJson.dependencies,
    ...packageJson.devDependencies
  };

  // Discord.js
  if ('discord.js' in dependencies) {
    return {
      name: 'discord.js',
      version: dependencies['discord.js'],
      knownPatterns: {
        magicConstants: [25, 90, 100, 1024, 4000, 6000],
        eventHandlers: ['.on(', '.once(', 'collector.on('],
        asyncPatterns: ['fire-and-forget-events']
      }
    };
  }

  // Express
  if ('express' in dependencies) {
    return {
      name: 'express',
      version: dependencies['express'],
      knownPatterns: {
        errorHandlers: ['app.use((err, req, res, next)'],
        asyncPatterns: ['middleware-next-callback']
      }
    };
  }

  return null;
}
```

**Integra√ß√£o:**

```typescript
// No in√≠cio do diagn√≥stico
const framework = detectFramework(process.cwd());

if (framework) {
  console.log(`üîç Framework detectado: ${framework.name} v${framework.version}`);
  console.log(`üìã Aplicando regras espec√≠ficas para ${framework.name}`);
}

// Passar para analistas
const context = { framework };
analisar(arquivos, config, context);
```

---

### üü¢ **Baixa Prioridade** (Vers√£o 0.4.0)

#### 9. **Modo interativo para review**

Comando: `npm run diagnosticar -- --interactive`

**Fluxo:**

```
üîç Analisando... (60 arquivos)
üìä Encontrados: 93 problemas

‚ñ∂Ô∏è  Iniciar review interativo? [Y/n]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
[1/93] hardcoded-secrets
üìÅ src/storage/config-mod.ts:224
const configKey = `squad_role_${squadType.toLowerCase()}`;

‚ùì √â falso positivo? [y/N/s=skip/q=quit]
> y

‚úÖ Adicionado ao .oraculoignore

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
[2/93] unhandled-async
...
```

---

#### 10. **Melhorias de UX e output**

**Output compacto:**

```typescript
// Antes
INFO    ‚Ä¢ vulnerabilidade-seguranca: 28
INFO    ‚Ä¢ problema-documentacao: 26

// Depois
üîê 28 seguran√ßa  |  üìö 26 documenta√ß√£o  |  üß™ 36 testes  |  üí° 3 sugest√µes
```

**Compara√ß√£o temporal:**

```typescript
// Salvar hist√≥rico em .oraculo/diagnostico-history.json
{
  "runs": [
    { "timestamp": "2025-12-01T12:00:00Z", "total": 101 },
    { "timestamp": "2025-12-01T13:00:00Z", "total": 93 }
  ]
}

// Mostrar diferen√ßa
üìä Resumo: 93 problemas (‚¨áÔ∏è -8 desde √∫ltima execu√ß√£o)
```

**Renomear categorias:**

```typescript
const CATEGORIAS_V3 = {
  'vulnerabilidade-seguranca': 'security',
  'problema-documentacao': 'code-clarity',
  'problemas-teste': 'test-quality',
  'tipo-literal-inline-complexo': 'complex-inline-types',
  'tipo-inseguro': 'unsafe-types'
};
```

---

## üì¶ Estrutura de Arquivos Novos

```
src/
  analistas/
    detectores/
      magic-constants-whitelist.ts          [NOVO]
  shared/
    helpers/
      framework-detector.ts                  [NOVO]
      suppressao.ts                          [ATUALIZAR]
  tipos/
    config-schema.ts                         [NOVO]
  core/
    config-loader.ts                         [ATUALIZAR]

docs/
  CONFIGURACAO.md                            [NOVO]
  PLANO-MELHORIAS-v0.3.0.md                 [ESTE ARQUIVO]

tests/
  shared/
    suppressao.test.ts                       [NOVO]
    framework-detector.test.ts               [NOVO]
  analistas/
    detectores/
      detector-seguranca-falsos-positivos.test.ts [NOVO]

.oraculoignore                               [NOVO - gerado interativamente]
```

---

## üß™ Estrat√©gia de Testes

### Testes para Falsos Positivos

```typescript
// tests/analistas/detectores/detector-seguranca-falsos-positivos.test.ts
describe('Detector Seguran√ßa - Falsos Positivos', () => {
  describe('hardcoded-secrets', () => {
    it('n√£o deve reportar string templates com interpola√ß√£o', () => {
      const codigo = 'const key = `squad_role_${type}`;';
      const problemas = detectarSeguranca(codigo);
      expect(problemas).toHaveLength(0);
    });

    it('n√£o deve reportar padr√µes da whitelist', () => {
      const codigo = 'const key = "squad_role_admin";';
      const config = { ignorePatterns: { 'hardcoded-secrets': { patterns: ['_role_'] } } };
      const problemas = detectarSeguranca(codigo, config);
      expect(problemas).toHaveLength(0);
    });

    it('DEVE reportar tokens reais Base64', () => {
      const codigo = 'const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9";';
      const problemas = detectarSeguranca(codigo);
      expect(problemas).toHaveLength(1);
      expect(problemas[0].tipo).toBe('hardcoded-secrets');
    });
  });

  describe('unhandled-async', () => {
    it('deve reduzir severidade em event handlers', () => {
      const codigo = `
        collector.on('collect', async (i) => {
          await i.deferUpdate();
        });
      `;
      const problemas = detectarSeguranca(codigo);
      const asyncProblema = problemas.find((p) => p.tipo.includes('async'));
      expect(asyncProblema?.severidade).toBe('baixa');
    });

    it('deve manter severidade m√©dia fora de event handlers', () => {
      const codigo = `
        async function processar() {
          await fazAlgo();
        }
      `;
      const problemas = detectarSeguranca(codigo);
      const asyncProblema = problemas.find((p) => p.tipo === 'unhandled-async');
      expect(asyncProblema?.severidade).toBe('media');
    });
  });
});
```

---

## üìä M√©tricas de Sucesso

**Antes (v0.2.0):**

- 301 ocorr√™ncias totais no Barqueiro
- ~40% falsos positivos
- Modo `--json` n√£o parseable
- `@oraculo-disable-next-line` n√£o funciona

**Depois (v0.3.0 - meta):**

- ~100 ocorr√™ncias totais (redu√ß√£o de 67%)
- <10% falsos positivos
- Modo `--json` 100% v√°lido
- Supress√£o inline funcionando
- Configura√ß√£o por framework autom√°tica

---

## üöÄ Cronograma Proposto

### Sprint 1 (Semana 1-2) ‚úÖ CONCLU√çDO

- [x] Criar este documento de planejamento
- [x] Corrigir `@oraculo-disable-next-line` (bug cr√≠tico)
- [x] Implementar configura√ß√£o granular de regras
- [x] Criar testes de supress√£o (suppressao.test.ts, suppressao-e2e.test.ts)

### Sprint 2 (Semana 3-4) ‚úÖ CONCLU√çDO

- [x] Corrigir modo `--json` (ativarModoJson implementado)
- [x] Reduzir logs verbosos no terminal
- [x] Melhorar formata√ß√£o de sa√≠da
- [ ] Reduzir falsos positivos hardcoded-secrets (parcial)
- [ ] Reduzir falsos positivos unhandled-async (parcial)

### Sprint 3 (Semana 5-6) üîÑ EM PROGRESSO

- [x] Reorganizar documenta√ß√£o (nova estrutura de pastas)
- [x] Criar guia de in√≠cio r√°pido para usu√°rios
- [ ] Implementar whitelist magic constants
- [ ] Detec√ß√£o autom√°tica de framework
- [ ] Melhorar exit codes

### Release v0.3.0 (Pendente)

- [ ] Testes E2E completos
- [ ] Valida√ß√£o com projeto Barqueiro
- [ ] CHANGELOG.md atualizado
- [ ] Release notes

---

## üìö Refer√™ncias

- **Feedback original:** `docs/FEEDBACK-ORACULO.md`
- **Config atual:** `oraculo.config.json`
- **Sistema supress√£o:** `src/shared/helpers/suppressao.ts`
- **Detector seguran√ßa:** `src/analistas/detectores/detector-seguranca.ts`

---

## ü§ù Feedback Cont√≠nuo

Ap√≥s implementa√ß√£o da v0.3.0, solicitar novo teste no projeto Barqueiro:

```bash
# No reposit√≥rio do Barqueiro
npm install oraculo@0.3.0
npm run diagnosticar -- --json > resultado-v0.3.0.json

# Comparar com v0.2.0
node compare-results.js resultado-v0.2.0.json resultado-v0.3.0.json
```

**M√©tricas a validar:**

- Redu√ß√£o de falsos positivos (meta: >70%)
- Tempo de execu√ß√£o (deve manter <1s para 60 arquivos)
- Exit codes corretos
- JSON mode funcional
- Supress√£o inline funcionando

---

**Status:** üîÑ Em Progresso (Sprint 3)
**Pr√≥ximo passo:** Implementar whitelist de magic constants e detec√ß√£o de framework
